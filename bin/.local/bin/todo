#!/bin/sh

todo_data_dir="${HOME}/.local/share/todo"
todo_file="$todo_data_dir/todo"

ensure_dir() {
  [ ! -d "$1" ] && mkdir -p "$1"
}

add_todo() {
  read -p "Enter todo note: " todo
  echo "$todo" >> $todo_file
}

list_todos() {
  echo "Todo list"
  [ -f "$todo_file" ] && cat -n $todo_file
}

which_todo() {
  todo=$(cat "$todo_file" | fzf -i --prompt="notes on todo: ")
  [ -z "$todo" ] && exit 0;
}

notes_todo() {
  which_todo
  note_name=$(echo "$todo" | sed 's/\s/-/g')
  note_path="$todo_data_dir/notes/$note_name.md"
  
  [ ! -f $note_path ] && echo "# $todo" > $note_path
  vim $note_path
}

del_todo() {
  which_todo
  read -p "Delete \"$todo\"? [y/n] " yes_no
  if [ "$yes_no" = "y" ]; then
    sed -i "/$todo/d" $todo_file
    echo "todo deleted"
  fi

  note_name=$(echo "$todo" | sed 's/\s/-/g')
  note_path="$todo_data_dir/notes/$note_name.md"

  [ -f "$note_path" ] && rm "$note_path"
}

print_help() {
  cat << EOF
todo - Utility to manage todos
Usage: todo [action]

Actions:
  add|a   - Add a todo item
  del|d   - Delete todo
  list|l  - List all items
  notes|n - Add/Edit notes on todo
  help    - Print this message
EOF
}

ensure_dir "$todo_data_dir"
ensure_dir "$todo_data_dir/notes"

if [ -z "$1" ]; then
  print_help
  exit 1
fi

action=$1
shift

case "$action" in
  add|a)
    add_todo
    ;;
  del|d)
    del_todo
    ;;
  list|l)
    list_todos
    ;;
  notes|n)
    notes_todo
    ;;
  *)
    print_help
    ;;
esac
