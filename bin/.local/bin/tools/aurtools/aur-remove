#!/bin/sh

set -uo pipefail
trap 's=$?; echo "$0: Error on line "$LINENO": $BASH_COMMAND"; exit $s' ERR

REMOTE_HOST="sol.vathsan.com"
REMOTE_PATH="$REMOTE_HOST:/var/www/arch-repo-x86_64"
LOCAL_PATH="/home/localpkgs"
REPO_NAME="sillyshrimp"

mkdir -p "$LOCAL_PATH"

rsync -azP "$REMOTE_PATH/$REPO_NAME".{db,files}.tar.xz "$LOCAL_PATH/"
ln -sf "$REPO_NAME.db.tar.xz" "$LOCAL_PATH/$REPO_NAME.db"
ln -sf "$REPO_NAME.files.tar.xz" "$LOCAL_PATH/$REPO_NAME.files"

repo-remove "$LOCAL_PATH/$REPO_NAME.db.tar.xz" "$@"

rsync -azP --copy-links "$LOCAL_PATH/$REPO_NAME".{db,files}{,.tar.xz} "$REMOTE_PATH/"
for package in "$@"; do
  ssh "$REMOTE_HOST" "rm $REMOTE_PATH/$package-*.pkg.tar.xz"
done
