#!/bin/bash
# vim: set ft=sh!

SOURCE_DIR="${HOME}/Packages"
PKGDEST="/srv/pkgs"
AUR_GIT_SERVER="https://aur.archlinux.org"

function help_msg() {
  cat << EOF
$(tput setaf 4)aurctl - Aur helper$(tput sgr0)
  $(tput setaf 2)ls$(tput sgr0)            List source packages
  $(tput setaf 2)ls -b$(tput sgr0)         List built packages
  $(tput setaf 2)ls -i$(tput sgr0)         List installed packages
  $(tput setaf 2)down [pkg]$(tput sgr0)    Install package
  $(tput setaf 2)pull [pkg]$(tput sgr0)    Pull from packages repo
  $(tput setaf 2)pull all$(tput sgr0)      Pull all source repos 
  $(tput setaf 2)rm [pkg]$(tput sgr0)      Remove pkg source dir
  $(tput setaf 2)help$(tput sgr0)          Print this
EOF
}

function clone() {
  git clone ${AUR_GIT_SERVER}/$1.git $SOURCE_DIR/$1
}

function list() {
  case "$1" in
    "")
    ls $SOURCE_DIR -1
    ;;
    
    "-i")
    pacman -Qm
    ;;

    "-b")
    ls /srv/pkgs -1 | sed -r 's/.pkg.tar.xz//g'
    ;;
  esac
}

function remove() {
  read -p "Do you wish to remove $1 (Y/n)? " yn
  case $yn in
    "") rm -rf $SOURCE_DIR/$1;;
    [Yy]* ) rm -rf $SOURCE_DIR/$1;;
    [Nn]* ) exit;;
  esac
}

function pull_pkg() {
  echo "$(tput setaf 4)$1$(tput sgr0)"
  git -C $SOURCE_DIR/$1 pull
  echo
}

function pull() {
  case "$1" in
    "")
    help_msg
    ;;

    "all")
    for i in `ls $SOURCE_DIR`; do pull_pkg $i; done
    ;;
    
    *)
    pull_pkg $1
    ;;
  esac
}

case "$1" in
  "ls")
  shift
  list $@
  ;;
  
  "clone")
  shift
  clone $@
  ;;

  "pull")
  shift
  pull $@
  ;;

  "rm")
  shift
  remove $@
  ;;

  "help"|"")
  help_msg
  ;;
esac
