#!/bin/sh

set -u
set -e
set -o pipefail

[ -e ~/.config/studio.conf ] && . ~/.config/studio.conf

fifo_path="${HOME}/.cache/studio.fifo"

tun_check() {
  if ! $(systemctl --user is-active sol_tunnel.service > /dev/null); then
    notify-send -t 1000 "Sol Tunnel not active"
    exit 0
  fi
}

stop_play() {
  if [ -e "$fifo_path" ]; then
    echo quit > "$fifo_path"
    rm "$fifo_path"
  fi
}

start_play() {
  mkfifo "$fifo_path"
  mpv --input-file="$fifo_path" --keep-open=always --no-audio-display --quiet \
    "$STUDIO_URL" > /dev/null < /dev/null &
}

toggle_play() {
  if [ -e "$fifo_path" ]
  then
    stop_play
  else
    start_play
  fi
}

case "$1" in
  play) toggle_play;;
  
  skip)
    tun_check
    mpc next
    ;;

  current)
    tun_check
    mpc current -f "%album% - %title%"
    ;;

  playlist)
    tun_check
    
    selected=$(
      echo -ne "albums\nsoundtracks\n$(mpc lsplaylists)" |
        rofi -dmenu -i -p "Select Playlist"
      )
    case $selected in
      albums|soundtracks)
        stop_play
        mpc clear
        mpc add "$selected"
        mpc play
        toggle_play
        ;;
      *)
        stop_play
        mpc clear
        mpc load "$selected"
        mpc play
        toggle_play
        ;;
    esac
    ;;
  albums)
    tun_check

    selected=$(
      cat $STUDIO_ALBUMS_FILE |
        rofi -dmenu -i -p "Select Album"
    )

    echo "$selected"
  
    [ -z "$selected" ] && exit 1;

    stop_play
    mpc clear
    mpc add "$selected"
    mpc play
    toggle_play
    ;;
esac
