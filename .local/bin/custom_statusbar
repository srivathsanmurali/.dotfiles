#!/bin/sh
[ -e ~/.config/studio.conf ] && . ~/.config/studio.conf

while true
do
  now_playing=$(
    curl -sL "${STUDIO_URL}/api/playing" \
    | jq --raw-output '"♫ " +  .album[0:20] + " - " + .title + " (" + .artist[0:20] + ")"'
  )
  time=" $(date +'%A, %b %d %0I:%M%p')"
  network=$(nmcli device status | grep "\bconnected\b" | awk '{print $4}')
  if [ -n "${network}" ]; then
    network=" ${network}"
  fi

  battery=$(
    cat /sys/class/power_supply/BAT*/capacity \
    | awk '{sum+=$NF} END {print int(sum/NR)}'
  )

  if [ $(cat /sys/class/power_supply/AC/online) == 1 ]; then
    battery=" ${battery}"
  fi

  if [ -z "$battery" ]; then
    printf "%s %s %s \n" "${now_playing}" "${network}" "${time}"
  else
    printf "%s %s %s %s \n" "${now_playing}" "${network}" "$battery" "${time}"
  fi
  sleep 10
done
